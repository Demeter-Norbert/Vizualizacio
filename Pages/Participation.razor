@page "/participation"
@inject HttpClient Http

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>👥 Részvételi Statisztikák</h3>
    <a href="/" class="btn btn-outline-secondary">← Vissza</a>
</div>

<div class="row mb-4 align-items-end">
    <div class="col-md-3">
        <label class="form-label">Válassz évet:</label>
        <select class="form-select shadow-sm" @onchange="OnYearChanged">
            <option value="2025">2025</option>
            <option value="2024">2024</option>
            <option value="2023">2023</option>
        </select>
    </div>
    <div class="col-md-9">
        @if (displayData != null)
        {
            <div class="alert alert-success mb-0 py-2 px-4 shadow-sm d-inline-block">
                <span class="fs-5">Összes résztvevő: <strong>@TotalCount</strong> diák</span>
            </div>
        }
    </div>
</div>

@if (displayData == null)
{
    <div class="text-center mt-5"><div class="spinner-border text-primary"></div></div>
}
else
{
    <div class="chart-container mb-4 overflow-auto">
        @{
            var rowHeight = 35;
            var chartHeight = displayData.Count * rowHeight + 50;
            var maxCount = displayData.Any() ? displayData.Max(d => d.Count) : 100;
            var chartWidth = 700; // A diagram belső szélessége
            var labelWidth = 50; // Hely a megyekódoknak
        }

        <svg width="100%" height="@chartHeight" viewBox="0 0 @(chartWidth + labelWidth + 80) @chartHeight" style="min-width: 600px;">
            <line x1="@labelWidth" y1="20" x2="@labelWidth" y2="@(chartHeight - 20)" stroke="#ddd" stroke-width="2" />

            @for (int i = 0; i < displayData.Count; i++)
            {
                var item = displayData[i];
                // Kiszámoljuk a sáv szélességét arányosan
                var barWidth = ((double)item.Count / maxCount) * chartWidth;
                var y = 30 + (i * rowHeight);

                <g class="bar-group">
                    <text x="@(labelWidth - 10)" y="@(y + 15)" font-size="12" text-anchor="end" font-weight="bold" alignment-baseline="middle">@item.County</text>

                    <rect x="@labelWidth" y="@y" width="@barWidth" height="20" fill="#1cc88a" rx="4" />

                    <text x="@(labelWidth + barWidth + 10)" y="@(y + 15)" font-size="11" fill="#333" font-weight="bold" alignment-baseline="middle">@item.Count</text>
                </g>
            }
        </svg>
    </div>
}

@code {
    private StatisticsData? allStats;
    private List<CountyCount>? displayData;
    private int selectedYear = 2025;

    // Összes résztvevő kiszámolása dinamikusan
    private int TotalCount => displayData?.Sum(d => d.Count) ?? 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            allStats = await Http.GetFromJsonAsync<StatisticsData>("statistics.json");
            FilterData();
        }
        catch (Exception ex) { Console.WriteLine(ex.Message); }
    }

    private void OnYearChanged(ChangeEventArgs e)
    {
        selectedYear = int.Parse(e.Value!.ToString()!);
        FilterData();
    }

    private void FilterData()
    {
        if (allStats != null)
        {
            displayData = allStats.Counts
                .Where(d => d.Year == selectedYear)
                .OrderByDescending(d => d.Count)
                .ToList();
        }
    }
}