@page "/distribution"
@inject HttpClient Http

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>📈 Pontszám Eloszlás</h3>
    <a href="/" class="btn btn-outline-secondary">← Vissza</a>
</div>

<div class="row mb-3">
    <div class="col-md-3">
        <select class="form-select shadow-sm" @onchange="OnYearChanged">
            <option value="2025">2025</option>
            <option value="2024">2024</option>
            <option value="2023">2023</option>
        </select>
    </div>
</div>

@if (displayData == null)
{
    <div class="text-center mt-5"><div class="spinner-border text-primary"></div></div>
}
else
{
    <div class="chart-container mb-4">
        @{
            var maxVal = displayData.Any() ? displayData.Max(d => d.Count) : 10;
        }
        <svg viewBox="0 0 800 400" width="100%" height="400">
            <line x1="50" y1="350" x2="780" y2="350" stroke="#ddd" stroke-width="2" />

            @for (int i = 0; i < displayData.Count; i++)
            {
                var item = displayData[i];
                var height = ((double)item.Count / maxVal) * 300.0;
                var y = 350 - height;
                var barWidth = (700 / displayData.Count) - 10;
                var x = 60 + (i * (barWidth + 10));

                <g>
                    <rect x="@x" y="@y" width="@barWidth" height="@height" fill="#f6c23e" rx="2" />

                    <text x="@(x + barWidth / 2)" y="370" font-size="10" text-anchor="middle">@item.Range</text>

                    <text x="@(x + barWidth / 2)" y="@(y - 8)" font-size="11" text-anchor="middle" font-weight="bold" fill="#333">@item.Count</text>
                </g>
            }
        </svg>
    </div>
}

@code {
    private StatisticsData? allStats;
    private List<ScoreDist>? displayData;
    private int selectedYear = 2025;

    protected override async Task OnInitializedAsync()
    {
        allStats = await Http.GetFromJsonAsync<StatisticsData>("statistics.json");
        FilterData();
    }

    private void OnYearChanged(ChangeEventArgs e)
    {
        selectedYear = int.Parse(e.Value!.ToString()!);
        FilterData();
    }

    private void FilterData()
    {
        if (allStats != null)
        {
            // Sorrendezés a tartomány szerint (szöveges, de a formátum miatt ABC sorrend jó lesz a számok növekedésének)
            displayData = allStats.Distribution
                .Where(d => d.Year == selectedYear)
                .OrderBy(d => d.Range)
                .ToList();
        }
    }
}